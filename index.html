<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sistema de Gestión de Bonificaciones</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <!-- App CSS -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- Loading -->
<div class="loading-spinner" id="loading" aria-live="polite" aria-busy="false">
  <div class="text-center" role="status">
    <div class="spinner-border text-primary" style="width:3rem;height:3rem" aria-hidden="true"></div>
    <div class="mt-3 fw-semibold">Cargando…</div>
  </div>
</div>

<!-- Login -->
<div id="loginScreen" class="login-wrap">
  <div class="login-card">
    <div class="text-center mb-3">
      <i class="fa-solid fa-scale-balanced fa-3x text-primary mb-3"></i>
      <h3 class="fw-bolder">Sistema de Bonificaciones</h3>
      <div class="subtle">Departamento Legal</div>
    </div>
    <button id="loginButton" class="btn btn-primary btn-lg w-100">
      <i class="fa-brands fa-microsoft me-2"></i> Iniciar sesión con Microsoft
    </button>
    <div class="text-center mt-3 subtle">Usa tu cuenta corporativa</div>
  </div>
</div>

<!-- App -->
<div id="mainApp" style="display:none">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fa-solid fa-scale-balanced me-2"></i> Bonificaciones
        <span id="userRoleBadge"></span>
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto pill-tabs">
          <li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#"><i class="fa-solid fa-house me-1"></i>Inicio</a></li>
          <li class="nav-item"><a class="nav-link" data-section="register" href="#"><i class="fa-solid fa-plus-circle me-1"></i>Registrar</a></li>
          <li class="nav-item"><a class="nav-link" data-section="history" href="#"><i class="fa-solid fa-clock-rotate-left me-1"></i>Historial</a></li>
          <li class="nav-item supervisor-only" style="display:none"><a class="nav-link" data-section="supervisor" href="#"><i class="fa-solid fa-users-gear me-1"></i>Supervisión</a></li>
          <li class="nav-item supervisor-only" style="display:none"><a class="nav-link" data-section="config" href="#"><i class="fa-solid fa-gear me-1"></i>Configuración</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logoutButton"><i class="fa-solid fa-right-from-bracket me-1"></i>Salir</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="main-container container">
    <!-- Dashboard -->
    <section id="dashboardSection" class="content-section">
      <div class="row g-3 align-items-end mb-2">
        <div class="col-md-4">
          <label class="form-label">Mes</label>
          <input type="month" class="form-control" id="monthSelector">
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-3">
          <div class="kpi">
            <i class="fa-solid fa-star"></i>
            <div><div class="subtle">Puntos del mes</div><div class="v1" id="monthPoints">0</div></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="kpi">
            <i class="fa-solid fa-business-time"></i>
            <div><div class="subtle">Días laborables</div><div class="v1" id="workDays">0</div></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="kpi">
            <i class="fa-solid fa-bullseye"></i>
            <div><div class="subtle">% meta</div><div class="v1" id="goalPercentage">0%</div></div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="kpi">
            <i class="fa-solid fa-trophy"></i>
            <div><div class="subtle">Bono</div><div class="v1" id="monthlyBonus">€0</div></div>
          </div>
        </div>
      </div>

      <div class="card mt-3 chart-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div><i class="fa-solid fa-chart-line me-2"></i><strong>Estado del mes</strong></div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-success badge-chip" id="stateBadge" role="status">En progreso</span>
          </div>
        </div>
        <div class="card-body px-3 pb-2">
          <div class="progress progress-modern mt-1" aria-label="Progreso hacia la meta del mes">
            <div class="progress-bar bar" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-describedby="progressMessage" style="width:0%"></div>
          </div>
          <div class="subtle mt-2" id="progressMessage" aria-live="polite"></div>
        </div>
        <div class="card-body pt-0">
          <div class="row g-3 align-items-stretch">
            <div class="col-lg-8">
              <div class="chart-wrap h-100">
                <canvas id="dailyPointsChart" role="img" aria-label="Gráfico de puntos diarios"></canvas>
              </div>
            </div>
            <div class="col-lg-4 d-flex flex-column">
              <div class="doughnut-wrap flex-grow-1 mb-2">
                <canvas id="gaugeChart" role="img" aria-label="Indicador de progreso general"></canvas>
              </div>
              <div class="daychips" id="dailyStatus" role="region" aria-label="Estado de días completados"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-regular fa-clock me-2"></i><strong>Últimas entradas</strong></div>
        <div class="card-body" id="recentEntries"></div>
      </div>
    </section>

    <!-- Registrar -->
    <section id="registerSection" class="content-section" style="display:none">
      <div class="card">
        <div class="card-header"><i class="fa-solid fa-plus-circle me-2"></i><strong>Registrar nueva entrada</strong></div>
        <div class="card-body">
          <form id="registerForm" novalidate>
            <div class="row g-3">
              <div class="col-md-3"><label class="form-label">Fecha</label><input type="date" class="form-control" id="fecha" required></div>
              <div class="col-md-3">
                <label class="form-label">Expediente</label>
                <input type="text" class="form-control" id="expediente" placeholder="EXP-2025-001" required>
                <div class="form-hint" id="expedienteError"></div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo de escrito</label>
                <select class="form-select" id="tipoEscrito" required>
                  <option value="">Seleccione un tipo…</option>
                </select>
                <div class="form-hint"><strong>Puntos:</strong> <span id="puntosPreview">-</span></div>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" type="submit"><i class="fa-solid fa-floppy-disk me-2"></i>Guardar</button>
              </div>
              <div class="col-12">
                <label class="form-label">Comentario (opcional)</label>
                <textarea class="form-control" id="comentario" rows="2" maxlength="500"></textarea>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Historial -->
    <section id="historySection" class="content-section" style="display:none">
      <div class="card">
        <div class="card-header"><i class="fa-solid fa-filter me-2"></i><strong>Filtros</strong></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">Desde</label><input type="date" class="form-control" id="filterDateFrom"></div>
            <div class="col-md-3"><label class="form-label">Hasta</label><input type="date" class="form-control" id="filterDateTo"></div>
            <div class="col-md-4"><label class="form-label">Tipo</label><select class="form-select" id="filterType"><option value="">Todos</option></select></div>
            <div class="col-md-2 d-flex align-items-end"><button class="btn btn-outline-primary w-100" id="applyFilters"><i class="fa-solid fa-magnifying-glass me-1"></i>Buscar</button></div>
          </div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-clock-rotate-left me-2"></i><strong>Historial</strong></div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle" id="historyTable">
            <thead><tr><th>Fecha</th><th>Expediente</th><th>Tipo</th><th>Puntos</th><th>Comentario</th><th>Acciones</th></tr></thead>
            <tbody id="historyTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Supervisor -->
    <section id="supervisorSection" class="content-section" style="display:none">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div><i class="fa-solid fa-filter me-2"></i><strong>Panel de supervisión</strong></div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" id="openExportModal"><i class="fa-solid fa-file-export me-1"></i> Exportar</button>
            <button class="btn btn-primary btn-sm" id="exportRankingCsv"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">Mes</label><input type="month" class="form-control" id="supervisorMonth"></div>
            <div class="col-md-4"><label class="form-label">Usuario</label><select class="form-select" id="supervisorUser"><option value="">Todos</option></select></div>
            <div class="col-md-2 d-flex align-items-end"><button class="btn btn-outline-primary w-100" id="supervisorFilter"><i class="fa-solid fa-magnifying-glass me-1"></i>Filtrar</button></div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-trophy me-2"></i><strong>Ranking del mes</strong></div>
        <div class="card-body" id="rankingTable"></div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-users me-2"></i><strong>Gestión de usuarios</strong></div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle">
            <thead><tr><th>Nombre</th><th>Email</th><th>Sede</th><th>Rol</th><th>Vacaciones</th><th>Acciones</th></tr></thead>
            <tbody id="usersManagementTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Configuración -->
    <section id="configSection" class="content-section" style="display:none">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div><i class="fa-solid fa-file-pen me-2"></i><strong>Tipos de escritos</strong></div>
          <button class="btn btn-success btn-sm" id="addEscritoType"><i class="fa-solid fa-plus me-1"></i>Agregar</button>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Nombre</th><th>Puntuación</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="escritosTypesTable"></tbody>
          </table>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-calendar-days me-2"></i><strong>Calendario laboral (festivos por sede)</strong></div>
        <div class="card-body">
          <div class="subtle">Gestiona festivos globales por sede. Los días laborables se calculan automáticamente L–V menos festivos; cada usuario puede tener vacaciones.</div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-coins me-2"></i><strong>Bonos</strong></div>
        <div class="card-body">
          <form id="bonusConfigForm" class="row g-3">
            <div class="col-md-3"><label class="form-label">Puntos/día (meta)</label><input type="number" step="0.25" class="form-control" id="puntosPorDia" required></div>
            <div class="col-md-3"><label class="form-label">Bono mensual (€)</label><input type="number" step="10" class="form-control" id="bonoMensual" required></div>
            <div class="col-md-3"><label class="form-label">Vigencia</label><input type="date" class="form-control" id="fechaVigencia" required></div>
            <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100" type="submit"><i class="fa-solid fa-floppy-disk me-2"></i>Guardar</button></div>
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fa-solid fa-clock-rotate-left me-2"></i><strong>Historial de cambios</strong></div>
        <div class="card-body table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Fecha</th><th>Usuario</th><th>Acción</th><th>Detalle</th></tr></thead>
            <tbody id="auditLogTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Editar entrada</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="editId">
        <div class="mb-2"><label class="form-label">Fecha</label><input type="date" class="form-control" id="editFecha" required></div>
        <div class="mb-2"><label class="form-label">Expediente</label><input type="text" class="form-control" id="editExpediente" required></div>
        <div class="mb-2"><label class="form-label">Tipo de escrito</label><select class="form-select" id="editTipoEscrito" required></select></div>
        <div class="mb-2"><label class="form-label">Comentario</label><textarea class="form-control" id="editComentario" rows="2"></textarea></div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" id="saveEdit">Guardar</button></div>
  </div></div>
</div>

<div class="modal fade" id="editEscritoModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="editEscritoTitle">Tipo de escrito</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="editEscritoForm">
        <input type="hidden" id="escritoId">
        <div class="mb-2"><label class="form-label">Nombre</label><input type="text" class="form-control" id="escritoNombre" required></div>
        <div class="mb-2"><label class="form-label">Puntuación</label><input type="number" step="0.25" class="form-control" id="escritoPuntuacion" required></div>
        <div class="form-check mt-2"><input type="checkbox" class="form-check-input" id="escritoActivo" checked><label class="form-check-label" for="escritoActivo">Activo</label></div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" id="saveEscritoType">Guardar</button></div>
  </div></div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Editar usuario</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="editUserForm">
        <input type="hidden" id="userId">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Nombre</label><input type="text" class="form-control" id="userNombre" readonly></div>
          <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="userEmail" readonly></div>
          <div class="col-md-4"><label class="form-label">Sede</label><input type="text" class="form-control" id="userSede" placeholder="Madrid/Sevilla…"></div>
          <div class="col-md-4"><label class="form-label">Rol</label><select class="form-select" id="userRol"><option value="usuario">Usuario</option><option value="supervisor">Supervisor</option></select></div>
          <div class="col-md-12">
            <label class="form-label">Vacaciones (YYYY-MM-DD, …)</label>
            <textarea class="form-control" id="userVacaciones" rows="2" placeholder="2025-08-15,2025-08-16…"></textarea>
            <div class="form-hint">Se descuentan de los laborables automáticos L–V y festivos de su sede.</div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button class="btn btn-primary" id="saveUser">Guardar</button></div>
  </div></div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Exportar reporte</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <div class="mb-2"><label class="form-label">Mes</label><input type="month" class="form-control" id="exportMonth"></div>
      <div class="mb-2">
        <label class="form-label">Alcance</label>
        <select class="form-select" id="exportScope">
          <option value="departamento">Todo el departamento</option>
          <option value="usuario">Un solo usuario</option>
        </select>
      </div>
      <div class="mb-2 d-none" id="exportUserWrap">
        <label class="form-label">Usuario</label>
        <select class="form-select" id="exportUser"></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline-primary" id="exportPdf"><i class="fa-solid fa-file-pdf me-1"></i> PDF</button>
      <button class="btn btn-primary" id="exportCsv"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
    </div>
  </div></div>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<!-- App (ESM) -->
<script type="module" src="js/app.js"></script>
</body>
</html>
